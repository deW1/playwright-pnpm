name: "üß∞ Lint Dockerfile"

on:
  pull_request:
    paths:
      - 'Dockerfile'
  push:
    branches:
      - main
    paths:
      - 'Dockerfile'
  workflow_dispatch:

jobs:
  hadolint:
    name: Run hadolint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: "üîç Run hadolint on Dockerfile"
        # Run hadolint via the official Docker image to lint the checked-out Dockerfile
        # Use a bind mount and run the hadolint binary explicitly. Pin the hadolint image for reproducibility.
        run: |
          HADOLINT_IMAGE=hadolint/hadolint:v2.14.0
          echo "Using hadolint image: ${HADOLINT_IMAGE}"
          # Mount the repo workspace into /work so the container can read the Dockerfile
          # Run hadolint but capture its exit code so the step doesn't fail immediately.
          # This allows us to always run the summary/comment steps and fail later based on the exit code.
          set +e
          docker run --rm -v "$GITHUB_WORKSPACE":/work -w /work ${HADOLINT_IMAGE} hadolint -f json Dockerfile > hadolint.json
          HADOLINT_EXIT_CODE=$?
          set -e
          echo "$HADOLINT_EXIT_CODE" > hadolint_exit_code

      - name: "üßæ Prepare hadolint summary"
        id: hadolint
        run: |
          # Count issues (jq is available on ubuntu runners)
          if [ -s hadolint.json ]; then
            ISSUES=$(jq 'length' hadolint.json || echo 0)
          else
            ISSUES=0
          fi
          echo "issues=$ISSUES" >> $GITHUB_OUTPUT

          # Publish full JSON as a multiline output (beware size limits)
          echo "report<<EOF" >> $GITHUB_OUTPUT
          cat hadolint.json 2>/dev/null || true
          echo "EOF" >> $GITHUB_OUTPUT

      - name: "üí¨ Comment hadolint results on PR"
        if: github.event_name == 'pull_request'
        run: |
          set -euo pipefail
          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO=${{ github.repository }}
          TOKEN=${{ secrets.GITHUB_TOKEN }}
          MARKER='<!-- hadolint-playwright-pnpm -->'

          # Read issues count (prepared earlier)
          ISSUES=${{ steps.hadolint.outputs.issues }}

          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          BODY="${MARKER}\n\n## hadolint report\n\n- Issues found: ${ISSUES}\n\nSee the workflow run for details: ${RUN_URL}"

          JSON_BODY=$(jq -n --arg body "$BODY" '{body: $body}')

          # Try to find an existing comment containing the marker
          EXISTING_ID=$(curl -s -H "Authorization: token $TOKEN" "https://api.github.com/repos/$REPO/issues/$PR_NUMBER/comments" | jq -r --arg marker "$MARKER" '.[] | select(.body|contains($marker)) | .id' | head -n1 || true)

          if [ -n "$EXISTING_ID" ] && [ "$EXISTING_ID" != "null" ]; then
            # Update existing comment
            curl -s -X PATCH -H "Authorization: token $TOKEN" -H "Content-Type: application/json" -d "$JSON_BODY" "https://api.github.com/repos/$REPO/issues/comments/$EXISTING_ID" >/dev/null
          else
            # Create a new comment
            curl -s -X POST -H "Authorization: token $TOKEN" -H "Content-Type: application/json" -d "$JSON_BODY" "https://api.github.com/repos/$REPO/issues/$PR_NUMBER/comments" >/dev/null
          fi

      - name: "‚öñÔ∏è Enforce hadolint result"
        if: always()
        run: |
          # Decide whether to fail the job based on hadolint exit code and event type
          EXIT_CODE=$(cat hadolint_exit_code 2>/dev/null || echo 0)
          echo "hadolint exit code: $EXIT_CODE"
          if [ "$EXIT_CODE" -ne 0 ]; then
            if [ "${{ github.event_name }}" = "push" ]; then
              echo "‚ùå hadolint failed (exit $EXIT_CODE) ‚Äî failing the job as this is a push to main"
              exit $EXIT_CODE
            else
              echo "‚ö†Ô∏è hadolint failed (exit $EXIT_CODE) ‚Äî not failing the job for PR runs"
              exit 0
            fi
          else
            echo "‚úÖ hadolint passed (exit 0)"
            exit 0
          fi
